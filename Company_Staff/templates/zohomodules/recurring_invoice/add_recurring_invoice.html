{% extends 'base.html' %}
{% block content %}
{% load static %}

<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<style>
  .modal{
    z-index: 9999;
    overflow: scroll;
  }

  .form-group{
    width: 40%;
  }

  .row:after {
    content: "";
    display: table;
    clear: both;
  }
  
  @media screen and (max-width: 600px) {
    .col-25, .col-75, input[type=submit] {
      width: 100%;
      margin-top: 0;
    }

    input[type=text], select, textarea {
      width: 100%;
    }
  }

  .dropdown input,
  .dropdown button {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
  }

  .dropdown.open input,
  .dropdown.open button {
    display: block;
  }

  .row a{
    color: rgb(218, 164, 48);
    font-size: 12px;
  }

  .table th a{
    color:rgb(218, 164, 48);
    font-size: 11px;
    margin-left: 100px;
  }

  ::-webkit-scrollbar {
    display: none;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1; 
  }

  ::-webkit-scrollbar-thumb {
    background: #888; 
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #555; 
  }

  .item{
    height: auto;
  }

  .labels{
    color: white; 
    font-size:2.5vh; 
    font-weight: bolder;
  }

  .btn-outline-warning:hover {
    color: black !important;
    font-weight: bold;
  }
  .dropdown-item.customers-options:hover, .dropdown-item.items-options:hover{
    background: blue !important;
    cursor: pointer;
  }
</style>

<div class="body-wrapper">
  <div class="container-fluid">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'company_dashboard' %}" class="text-warning-emphasis">Dashboard</a></li>
        <li class="breadcrumb-item"><a class="text-warning-emphasis">Sales</a></li>
        <li class="breadcrumb-item"><a href="{% url 'recurringInvoice' %}" class="text-warning-emphasis">Recurring Invoice</a></li>
        <li class="breadcrumb-item" aria-current="page">Create</li>
      </ol>
    </nav>
      <div class="row mt-5">
          <div class="col-md-12">
            <div class="card mb-5 px-3 py-4" style="background-color: black; border-radius: 1vh;">
              <h1 class="mb-0 text-uppercase text-right" style="color: white; font-weight: bolder;">CREATE RECURRING INVOICE</h1><br>
              <hr class="text-warning">
              <form action="{% url 'createRecurringInvoice' %}" method="post" enctype="multipart/form-data"id="myForm" onsubmit="return validateForm()">
                {% csrf_token %}
                <div class="row">
                  <div class="col-md-3">
                    <label for="" class="labels">Customer</label>
                    <br>
                    <span class="text-danger" id="custErr"></span>
                  </div>
                  <div class="col-md-6">
                    <input type="hidden" name="customerId" id="customerId" value="">
                    <div class="d-flex">
                        <div class="w-100">
                            <div class="p-0 border-0 bg-none position-relative drop-box">
                                <input required type="text" id="customer" value="" name="customer" class="dropdown-toggle form-control text-white customers-display" onkeyup="filterCustomers()" data-bs-toggle="dropdown" aria-expanded="false" placeholder="Select Customer.." autocomplete="off">
                                <ul class="dropdown-menu w-100 customers-available position-absolute bg-black text-white" id="cust_drop"  style="overflow-y: auto; height: fit-content;max-height: 40vh; border: 1px solid gray;"> 
                                    <li class="dropdown-item customers-options text-white" onclick="getCustomerDetails('','')">Select Customer</li>
                                    {% for cust in customers %}
                                    <li class="dropdown-item customers-options text-white" onclick="getCustomerDetails(`{{cust.id}}`,this.innerHTML)">{{ cust.title }} {{ cust.first_name }} {{ cust.last_name }}</li>
                                    {% endfor %}
                                </ul>
                                
                            </div>
                        </div>
                        <button type="button" data-bs-toggle="modal" data-bs-target="#newCustomer" class="btn btn-outline-warning py-2 ms-1">+</button>
                    </div>
                  </div>
                </div>
                
                <div class="row mt-2">
                  <label for="" class="col-md-3 labels">Email</label>
                  <div class="col-md-6">
                    <input type="text" class="form-control text-white bg-black" id="customerEmail" name="customer_email" readonly>
                  </div>
                </div>

                <div class="row mt-2">
                  <label for="" class="col-md-3 labels">GST Type</label>
                  <div class="col-md-6">
                    <input type="text" class="form-control text-white bg-black" id="customerGstType" name="customer_gst_type" readonly>
                  </div>
                </div>

                <div class="row mt-2" id="customerGstInDisplay" style="display: flex;">
                  <label for="" class="col-md-3 labels">GSTIN</label>
                  <div class="col-md-6">
                    <input type="text" class="form-control text-white bg-black" id="customerGSTIN" name="customer_gstin" readonly>
                  </div>
                </div>

                <div class="row mt-2">
                  <label for="" class="col-md-3 labels">Billing Address</label>
                  <div class="col-md-6">
                    <textarea class="form-control text-white bg-black" name="bill_address" id="billAddress" rows="4" readonly></textarea>
                  </div>
                </div>

                <div class="row mt-2">
                  <label for="" class="col-md-3 labels">Place of Supply</label>
                  <div class="col-md-6">
                    <input hidden value="{{cmp.state}}" id="cmpstate">
                    <select name="place_of_supply" id="placeOfSupply" class="form-control bg-black text-white">
                      <option value="" selected>Select Place of Supply</option>
                      <option value="[AN]-Andaman And Nicobar Islands">[AN]-Andaman And Nicobar Islands</option>
                      <option value="[AD]-Andhra Pradesh">[AD]-Andhra Pradesh</option>
                      <option value="[AR]-Arunachal Pradesh">[AR]-Arunachal Pradesh	</option> 
                      <option value="volvo">[AS]-Assam</option>
                      <option value="[BR]-Bihar">[BR]-Bihar</option> 
                      <option value="volvo">[CH]-	Chandhigarh</option>
                      <option value="[CG]-Chattisgarh">[CG]-Chattisgarh</option>
                      <option value="[DD]-Daman Diu">[DD]-Daman Diu</option>
                      <option value="volvo">[DL]-	Delhi</option>
                      <option value="[GA]-Goa">[GA]-Goa</option> 
                      <option value="[GJ]-Gujarat">[GJ]-Gujarat</option>
                      <option value="[HR]-Haryana">[HR]-Haryana</option> 
                      <option value="[HP]-Himachal Pradesh">[HP]-Himachal Pradesh</option>
                      <option value="[JK]-Jammu And Kashmir">[JK]-Jammu And Kashmir</option>
                      <option value="[JH]-Jharkand">[JH]-Jharkand</option>
                      <option value="[KA]-Karnataka">[KA]-Karnataka</option>
                      <option value="[KL]-Kerala">[KL]-Kerala</option>
                      <option value="[LA]-Ladakh">[LA]-Ladakh</option>
                      <option value="[LD]-Lakshadweep">[LD]-Lakshadweep</option>
                      <option value="[MP]-Madhyapradesh">[MP]-Madhyapradesh</option>
                      <option value="[MH]-Maharashtra">[MH]-Maharashtra</option>
                      <option value="[MN]-Manipur">[MN]-Manipur</option>  
                      <option value="[ML]-Meghalaya">[ML]-Meghalaya</option>
                      <option value="[MZ]-Mizoram">[MZ]-Mizoram</option>
                      <option value="[NL]-Nagaland">[NL]-Nagaland</option> 
                      <option value="[NL]-Nagaland">[NL]-Nagaland</option>
                      <option value="[OD]-Odisha">[OD]-Odisha</option>
                      <option value="[PY]-Puducherry">[PY]-Puducherry</option>
                      <option value="[PB]-Punjab">[PB]-Punjab.</option>
                      <option value="[RL]-Rajasthan">[RL]-Rajasthan</option>
                      <option value="[SK]-Sikkim">[SK]-Sikkim</option>
                      <option value="[TN]-Tamilnadu">[TN]-Tamilnadu</option>
                      <option value="[TS]-Telenghana">[TS]-Telenghana</option>
                      <option value="[TR]-Tripura">[TR]-Tripura</option>
                      <option value="[UP]-Uttar Pradesh">[UP]-Uttar Pradesh</option>
                      <option value="[UK]-Utharakhand">[UK]-Utharakhand</option>
                      <option value="[WB]-West Bengal">[WB]-West Bengal</option>
                      <option value="[OT]-Other Territory">[OT]-Other Territory</option>
                  </select>
                  </div>
                </div>

                <hr>
                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Profile Name</label>
                      <div class="col-md-9">
                        <input type="text" class="form-control text-white bg-black" id="profileName" name="profile_name">
                      </div>
                    </div>
                  </div>
  
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Entry Type</label>
                      <div class="col-md-9">
                        <select class="form-control bg-black text-white" id="entryType" name="entry_type">
                          <option value="">Select Entry Type</option>
                          <option value="Invoice">Invoice</option>
                          <option value="Bill of Supply">Bill of Supply</option>
                      </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <div class="col-md-3">
                        <label for="" class="labels">RI No.</label>
                      </div>
                      <div class="col-md-9">
                        <input type="text" class="form-control bg-black text-white" name="rec_invoice_no"  id="recInvoiceNumber" placeholder="{{invNo}}" required>
                        <span class="text-danger ml-1" id="invNoErr"></span>
                      </div>
                    </div>
                  </div>
  
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Reference No.</label>
                      <div class="col-md-9">
                        <input type="text" class="form-control bg-black text-white" name="reference_number" value="{{ref_no}}" readonly>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Start Date</label>
                      <div class="col-md-9">
                        <input type="date" class="form-control bg-black text-white" id="startDate" name="start_date" value="{% now 'Y-m-d' %}">
                      </div>
                    </div>
                  </div>
  
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Terms</label>
                      <div class="col-md-9">
                        <div class="d-flex">
                          <select class="form-control bg-black text-white" name="payment_term" id="paymentTerm" required>
                              <option value="" selected> Select Payment Term</option>
                              {% for term in pTerms %}
                                  <option value="{{term.id}}" text="{{term.days}}">{{term.term_name}}</option>
                              {% endfor %}
                          </select>
                          <a class="btn btn-outline-warning ms-1" role="button" data-target="#newPaymentTerm" data-toggle="modal" id="termsadd">+</a>
                      </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">End Date</label>
                      <div class="col-md-9">
                        <input type="text" id="endDate" class="form-control bg-black text-white" name="end_date" readonly>
                      </div>
                    </div>
                  </div>
  
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Repeat Every</label>
                      <div class="col-md-9">
                        <div class="d-flex">
                          <select class="form-control bg-black text-white" name="repeat_every" id="repeatEvery" required>
                            <option value="" selected> Select Repeat Duration</option>
                            {% for r in repeat %}
                                <option value="{{r.id}}">{{r.repeat_every}}</option>
                            {% endfor %}
                        </select>
                        <a class="btn btn-outline-warning ms-1" role="button" data-target="#newRepeatEvery" data-toggle="modal" id="addRepeatEvery">+</a>
                      </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Order No.</label>
                      <div class="col-md-9">
                        <input class="form-control bg-black text-white" type="text" name="order_number" id="orderNum">
                      </div>
                    </div>
                  </div>
  
                  <div class="col-md-6 mt-2">
                    <div class="row">
                      <label for="" class="col-md-3 labels">Payment Type</label>
                      <div class="col-md-9">
                        <select class="form-control bg-black text-white" id="paymentMethod" name="payment_method">
                          <option value="" selected>Select Payment Method</option>
                          <option value="Cash">Cash</option>
                          <option value="Cheque">Cheque</option>
                          <option value="UPI">UPI</option>
                          {% for b in banks %}
                          <option value="{{b.bnk_name}}" text="{{b.id}}">{{b.bnk_name}} (XXX{{ b.bnk_acno|slice:"-4:" }})</option>
                          {% endfor %}
                      </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mt-2">
                    <div class="row" style="display:none;"  id="chequediv">
                      <div class="col-md-3">
                        <label for="" class="labels">Cheque No.</label>
                      </div>
                      <div class="col-md-9">
                        <input type="text" class="form-control bg-black text-white" name="cheque_id" id="cheque_id" placeholder="Enter Cheque No">
                      </div>
                    </div>

                    <div class="row" style="display:none;"  id="upidiv">
                      <div class="col-md-3">
                        <label for="" class="labels">UPI No.</label>
                      </div>
                      <div class="col-md-9">
                        <input type="text" class="form-control bg-black text-white" name="upi_id" id="upi_id" placeholder="Enter UPI ID">
                      </div>
                    </div>

                    <div class="row" style="display:none;"  id="bnkdiv">
                      <div class="col-md-3">
                        <label for="" class="labels">Bank Acc No.</label>
                      </div>
                      <div class="col-md-9">
                        <input type="text" class="form-control bg-black text-white" name="bnk_id" id="bnk_id" readonly>
                      </div>
                    </div>

                  </div>

                  <div class="col-md-6 mt-2"></div>
                </div>

                <div class="row mt-2" id="applyPriceListSection">
                  <div class="col-md-6">
                      <div class="form-group form-check">
                          <input type="checkbox" class="form-check-input" name="priceList" id="applyPriceList" value="applyPriceList">
                          <label class="form-check-label labels" for="applyPriceList">Apply Price List</label>
                          <br>
                          <span class="text-success" id="custPriceListName" style="display: none;"></span>
                      </div>
                  </div>
                  <div class="col-md-6"></div>
              </div>
              <div class="row mt-2">
                <div class="col-md-6" id="priceListDropdown" style="display: none;">
                  <div class="row">
                    <div class="col-md-3">
                      <label class="labels">Price List</label>
                    </div>
                    <div class="col-md-9">
                      <select class="form-control bg-black text-white" id="priceListIds" name="price_list_id" style="background-color: #43596c;">
                          <option value="">Choose Price List</option>
                          {% for p in priceListItems %}
                          <option value="{{p.id}}">{{p.name}}</option>
                          {% endfor %}
                      </select>
                      <span class="text-danger" id="custPriceListAlert" style="display: none;"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-12 table-responsive">
                  <table class="table table-bordered" id="invoiceItemsTable">
                    <thead>
                        <tr>
                            <th class="text-center text-white" style="width: 3%;">#</th>
                            <th class="text-center text-white" style="width: 20%;">PRODUCT</th>
                            <th class="text-center text-white" style="width: 11%;">HSN</th>
                            <th class="text-center text-white" style="width: 15%;">QTY</th>
                            <th class="text-center text-white" style="width: 12%;">PRICE</th>
                            <th class="text-center text-white" style="width: 15%;">TAX (%)</th>
                            <th class="text-center text-white" style="width: 9%;">DISCOUNT</th>
                            <th class="text-center text-white" style="width: 12%;">TOTAL</th>
                            <th style="width: 3%;"></th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <tr id='tab_row1'>
                            <td class="nnum  bg-black text-white" style="text-align: center;">1</td>
                            <td>
                                <div class="d-flex">
                                    <div class="w-100">
                                        <div class="p-0 border-0 bg-none position-relative drop-box" style="display: block;">
                                            <input required type="text" id="item1" value="" name="item_name[]" class="dropdown-toggle form-control text-white item-display" onkeyup="filterFunction($(this).attr('id'))"  data-bs-toggle="dropdown" aria-expanded="false" placeholder="Items.." autocomplete="off">
                                            <ul class="dropdown-menu w-100 items-available position-absolute bg-black text-white" id="menu1"  style="overflow-y: auto; height: fit-content;max-height: 40vh; border: 1px solid gray;"> 
                                                {% for i in items %}
                                                <li class="dropdown-item items-options text-white" onclick="getItemDetails($(this).parent().prev().attr('id'),`{{i.item_name}}`)">{{i.item_name}}</li>
                                                {% endfor %}
                                            </ul>
                                            
                                        </div>
                                    </div>
                                    <a href="#">
                                        <button type="button" class="btn btn-outline-warning ms-1" data-target="#newItem" data-toggle="modal">+</button>
                                    </a>
                                </div>
                            
                            </td>
                            <td>
                                <input type="hidden" name="item_id[]" id="itemId1">
                                <input type="text" name='hsn[]' id="hsn1" placeholder='HSN' class="form-control bg-black text-white HSNCODE" readonly />
                            </td>
                            <td >
                                <input type="number" name='qty[]' id="qty1"  class="form-control bg-black text-white qty mb-1" step=0 min=1 value=0 onchange="changeItemQty(this.id)" required/>
                                <input type="text" id="avl1" style="display: none;">
                                <div class="d-flex text-white" style="font-size: 0.7rem;"><span>Available Qty:</span><span id="qtyspan1" class=''></span></div>
                            </td>
                            <td>
                                <input type="number" name='price[]' id="price1" class="form-control bg-black text-white price" step="0.00" min="0" style="display: block;" value=0 readonly />
                                <input type="number" name='priceListPrice[]' id="priceListPrice1" class="form-control bg-black text-white priceListPrice" step="0.00" min="0" style="display: none;" value=0 readonly />
                            </td>
                            
                            <td>
                                <!-- <input type="text"  id="select_tax" placeholder="Tax Rate" class="form-control seltax d-flex"> -->
                                <select name='taxGST[]' id="taxGST1" class="form-control bg-black text-white tax_ref tax_ref_gst" style="display: block;" onchange="taxchange(this.id)">
                                    <option selected disabled hidden>Select GST</option>
                                    <option value=28 >28.0% GST</option>
                                    <option value=18 >18.0% GST</option>
                                    <option value=12 >12.0% GST</option>
                                    <option value=5 >05.0% GST</option>
                                    <option value=3 >03.0% GST</option>
                                    <option value=0 >0.0% GST</option>
                                </select>
                                <select name='taxIGST[]' id="taxIGST1" class="form-control bg-black text-white tax_ref tax_ref_igst" style="display: none;" onchange="taxchange(this.id)">
                                    <option selected disabled hidden >Select IGST</option>
                                    <option value=28 >28.0% IGST</option>
                                    <option value=18 >18.0% IGST</option>
                                    <option value=12 >12.0% IGST</option>
                                    <option value=5 >05.0% IGST</option>
                                    <option value=3 >03.0% IGST</option>
                                    <option value=0 >0.0% IGST</option>
                                </select>
                                <div class="mt-1" style=" text-align: center;color: red;" ><span id="invalidtax1" style="display: none;"> Invalid Tax %</span> </div>    
                            </td>
                            <td >
                                <input type="number" name='discount[]'  placeholder='Enter Discount' id="disc1" value=0 class="form-control bg-black text-white disc" step='any' min=0  />
                            </td>

                            <td><input type="number" name='total[]' id="total1" class="form-control bg-black text-white total" value=0 readonly /></td>
                            <td style="display: none;"><input type="hidden" id="taxamount1" class="form-control itemTaxAmount" /></td>
                            <td>
                              <i class="fa fa-trash text-danger remove_row" style="cursor: pointer;" title="Remove Row" id="1"></i>
                            </td>
                        </tr>
                    </tbody>
                    <tr>
                        <td colspan="9"><a class="btn btn-outline-warning ms-1" role="button" id="add" >+</a></td>
                    </tr>
                  </table>
                </div>
              </div>


              <div class="row clearfix" style="margin-top:20px">
                <div class="col-md-6">
                    <textarea class="form-control bg-black text-white mt-3"  id="" name="note" placeholder="Note" style="height: 190px;"></textarea>
                    <input type="file" class="form-control" name="file"  style="margin-top: 10px;">
                    <textarea class="form-control bg-black text-white mt-3"  id="" name="terms" placeholder="Terms & conditions" style="height: 130px;"></textarea>
                </div>            
                <div class="col-md-1"></div>
                <div class="col-md-5 table-responsive-md mt-3 " id="invoiceItemsTableTotal" style="background-color:rgba(0,0,0,.4); border: 1px solid rgba(128, 128, 128, 0.6); margin-left: -2vh;">
                    <div class="p-3">
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label class="text-center text-white">Sub Total</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" step="any" name='subtotal' value=0.00 readonly class="form-control bg-black text-white" id="sub_total"></div>
                        </div>
                        <div class="row container-fluid p-2 m-0" id="taxamountIGST" style="display: flex;">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">IGST</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" name='igst' step="any" id="igstAmount" value=0.00 readonly class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0" style="display: none;" id="taxamountCGST">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">CGST</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" name='cgst' step="any" id="cgstAmount" value=0.00 readonly class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0" style="display: none;" id="taxamountSGST">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-cente text-white">SGST</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" name='sgst' step="any" id="sgstAmount" value=0.00 readonly class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Tax Amount</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" step="any" name='taxamount' id="tax_amount" value=0.00 readonly class="form-control bg-black text-white"/></div>
                        </div>
                        
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Ship Charge</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" step="any" name='ship' id="ship" value=0.00 class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Adjustment</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" step="any" name='adj' id="adj" value=0.00 class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Grand Total</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" name='grandtotal' id="grandtotal" value=0.00 readonly class="form-control bg-black text-white"/></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-7"></div>
                <div class="col-md-5 table-responsive-md mt-3 " id="invoiceItemsTablePaid" style="background-color:rgba(0,0,0,.4); border: 1px solid rgba(128, 128, 128, 0.6); margin-left: -2vh;">
                    <div class="p-3">
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Paid Off</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" step="any" name='advance' id="advance"  value=0.00 class="form-control bg-black text-white"/></div>
                        </div>
                        <div class="row container-fluid p-2 m-0">
                            <div class="col-sm-4 mt-2"><label for="a" class="text-center text-white">Balance</label></div>
                            <div class="col-sm-1 mt-2">:</div>
                            <div class="col-sm-7 mt-2"><input type="number" name='balance' id="balance" value=0.00 readonly class="form-control bg-black text-white" readonly /></div>
                        </div>
                    </div>
                </div>
            </div>
                




                <br>
                <div class="mt-4">
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="agreeTerms" required>
                      <label for="agreeTerms">Agree to terms and conditions</label>
                      <div class="invalid-feedback">You must agree before submitting.</div>
                  </div>
                </div>
                <div class="mt-4">
                  <input type="submit" class="btn save_btn" style="background-color: chocolate; color: white;" value="SAVE" name="Saved" id="save">
                  <input class="btn save_btn" style="background-color: chocolate; color: white;" type="submit" value="DRAFT" name="Draft" id="draft">
                  <input class="btn save_btn" style="background-color: chocolate; color: white;" type="reset" onclick="window.location.href=`{% url 'recurringInvoice' %}`" value="CANCEL" id="cancel">
                </div>
              </form>
            </div>
          </div>
      </div>
  </div>
</div>


<!-- Payment term modal -->
<div class="modal fade" id="newPaymentTerm">
  <div class="modal-dialog modal-md">
  <div class="modal-content" style="background: rgb(32, 35, 37);border-radius: 20px;">
      <div class="modal-header px-3" style="background: rgb(32, 35, 37);">
          <h3 class="text-uppercase" style="color: white;">Add Payment Term</h3>
          <button type="button" class="close btn btn-danger" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body" style="background: rgb(32, 35, 37);">
      <div class="card px-2 py-4" style="background-color: #141414a2;">
          <form action="" method="post" class="needs-validation" novalidate autocomplete="off" id="newTermForm">
          
          <div class="row mt-2">

              <div class="col-lg-12 col-md-12 col-sm-12 mt-2">
                  <label for="termname" style="color: white">Term Name *</label>

                <input type="text " class="form-control text-dark bg-light mt-2" id="termName" name="term_name" autocapitalize="characters" required> 
                <span id="message-id" class="mt-1 text-danger" style="font-size: 10px;"></span> 
                <span id="success-message-id" class=" mt-1 text-success" style="font-size: 10px;"></span>    
              </div>

              <div class="col-lg-12 col-md-12 col-sm-12 mt-2">
                    <label for="termdays" style="color: white">Number of Days *</label>

                <input type="number" class="form-control text-dark bg-light mt-2" id="termDays" name="term_days" autocapitalize="characters" required>
                </div>
                <div class="col-md-2 mt-2"></div>

            </div>
          
                <div class="row mt-5">
                  <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="d-flex">
                      <button class="btn save_btn rounded-pill text-grey w-50 my-1 mx-1 btn-outline-warning "
                      type="submit" data-dismiss="modal" id="savePaymentTerm">Save
                      </button> 
                      

                      <button type="button" class="close btn save_btn rounded-pill text-grey w-50 my-1 mx-1 btn-outline-warning" 
                      data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">Cancel</span>
                      </button>
                    </div>
                  </div>
              </div>
            </form>
          </div>
        </div>
      </div>
  </div>  
</div>


<!-- Repeat Every -->
<div class="modal fade" id="newRepeatEvery">
  <div class="modal-dialog modal-md">
  <div class="modal-content" style="background: rgb(32, 35, 37);border-radius: 20px;">
      <div class="modal-header px-3" style="background: rgb(32, 35, 37);">
          <h3 class="text-uppercase" style="color: white;">Add Repeat Every</h3>
          <button type="button" class="close btn btn-danger" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
      </div>
      <div class="modal-body" style="background: rgb(32, 35, 37);">
      <div class="card px-2 py-4" style="background-color: #141414a2;">
          <form action="" method="post" class="needs-validation" novalidate autocomplete="off" id="newRepeatEveryForm">
            {% csrf_token %}

            <div class="row mt-2">
              <div class="col-6">
                  <label class="text-white" for="name">Duration*</label>
                  <input type="number" name="repeat_duration" min="0" step="any" id="repeatEveryDuration" class="form-control text-dark bg-light w-100">
              </div>
              <div class="col-6">
                  <label class="text-white" for="name">Type*</label>
                  <select name="repeat_type" id="repeatEveryType" class="form-control text-dark bg-light w-100">
                      <option value="Month">Month</option>
                      <option value="Year">Year</option>
                  </select>
              </div>
          </div>
          
                <div class="row mt-5">
                  <div class="col-lg-12 col-md-12 col-sm-12">
                    <div class="d-flex">
                      <button class="btn save_btn rounded-pill text-grey w-50 my-1 mx-1 btn-outline-warning "
                      type="submit" data-dismiss="modal" id="saveRepeatEvery">Save
                      </button> 
                      

                      <button type="button" class="close btn save_btn rounded-pill text-grey w-50 my-1 mx-1 btn-outline-warning" 
                      data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">Cancel</span>
                      </button>
                    </div>
                  </div>
              </div>
            </form>
          </div>
        </div>
      </div>
  </div>  
</div>

<script>
  function filterCustomers(){
      var options = $('#cust_drop').children();
      var search_text = $("#customer").val().toLowerCase();
      options.each(function(){
          if($(this).text().toLowerCase().includes(search_text)){
              $(this).show()
          }else{
              $(this).hide()
          }
      })
  }

    function getCustomerDetails(custId, name){
      $('#customer').val(name)
      console.log('name',name);
      if($('#customer').val() != ""){
          $('#custErr').text('');
          $.ajax({
              type : 'POST',
              url: "{% url 'getCustomerDetailsAjax' %}",
              data: {
                  id: custId,
                  csrfmiddlewaretoken: '{{ csrf_token }}',
              },
              
              success: function(data){
                  console.log('AJAX-Response-->',data);
                  document.getElementById('customerId').value = data.id;
                  document.getElementById('customerEmail').value = data.email;
                  document.getElementById('placeOfSupply').value = data.shipState;
                  document.getElementById('customerGstType').value = data.gstType;
                  document.getElementById('billAddress').value = data.street + ',' + data.city + '\n' + data.state + '\n' + data.country  + '\n' + data.pincode ;
                  if(data.gstin){
                      document.getElementById('customerGstInDisplay').style.display = 'flex';
                      document.getElementById('customerGSTIN').value = data.gstNo;
                  }else{
                      document.getElementById('customerGstInDisplay').style.display = 'none';
                      document.getElementById('customerGSTIN').value = '';
                  }
                  $('#applyPriceList').prop('checked') ? $('#applyPriceList').prop('checked', false) : $('#applyPriceList').prop('checked',false);
                  refreshTax();
                  checkPriceList();
              }
          });
      }else{
          document.getElementById('customerEmail').value = "";
          document.getElementById('placeOfSupply').value = "";
          document.getElementById('customerGstType').value = "";
          document.getElementById('billAddress').value ="";
          document.getElementById('customerGSTIN').value = "";
          $('#custErr').text('Select a customer..');
      }
  }


  $(document).ready(function() {
        $("#paymentMethod").change(function() {
            var x=$('#paymentMethod').val();
            if(x==='Cash'){
                $('#chequediv').hide()
                $('#bnkdiv').hide()
                $('#upidiv').hide()
                document.getElementById('cheque_id').value=""
                document.getElementById('upi_id').value=""
                document.getElementById('bnk_id').value=""
            }else if(x==='Cheque'){
                $('#chequediv').show()
                $('#bnkdiv').hide()
                $('#upidiv').hide()
                document.getElementById('upi_id').value=""
                document.getElementById('bnk_id').value=""
            }else if(x==='UPI'){
                $('#upidiv').show()
                $('#bnkdiv').hide()
                $('#chequediv').hide()
                document.getElementById('cheque_id').value=""
                document.getElementById('bnk_id').value=""
            }else{
                $('#bnkdiv').show()
                $('#chequediv').hide()
                $('#upidiv').hide()
                document.getElementById('cheque_id').value=""
                document.getElementById('upi_id').value=""

                $.ajax({
                    type: "GET",
                    url: "{% url 'getBankAccountNumberAjax' %}",
                    data: {
                        id: $('#paymentMethod').find(':selected').attr('text'),
                    },
                    success: function (response) {
                        if (response.status){
                            document.getElementById('cheque_id').value="";
                            document.getElementById('upi_id').value="";
                            document.getElementById("bnk_id").value = response.account;
                        }else{
                            alert(response.message);
                        }
                    }
                });
            }
        });
    });

    $(document).on("click","#saveRepeatEvery",function(){
        var duration = $('#repeatEveryDuration').val();
        var type = $("#repeatEveryType").val();
        if (! isNaN(duration) && type !=""){
            $.ajax({
                type : 'POST',
                url:"{% url 'newRepeatEveryTypeAjax' %}",
                data:{
                    'duration' : duration,
                    'type' : type,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                
                success: function(response) {
                    if(response.status){
                        document.getElementById("newRepeatEveryForm").reset();
                        
                        var dropdown = $('#repeatEvery');
                        dropdown.empty();
                        dropdown.append(`<option value=""> Select Repeat Duration</option>`);
                        $.each(response, function(key, value) {
                            for(let i=0; i<value.length; i++){
                                if(value[i].repeat_every == (duration+" "+type).toString()){
                                    dropdown.append($('<option selected></option>').text(value[i].repeat_every).val(value[i].id))
                                }else{
                                    dropdown.append($('<option></option>').text(value[i].repeat_every).val(value[i].id))
                                }   
                            }
                        });
                    }else{
                        alert("Something went wrong.!")
                    }
                },         
            });
        }
        else{
            alert('Invalid.!')
        }
    });

    $(document).on("click","#savePaymentTerm",function(){
        var trm = $('#termName').val();
        var dys = $("#termDays").val();
        if (trm !="" && dys !=""){
            $.ajax({
                type : 'POST',
                url:"{% url 'newPaymentTermAjax' %}",
                data:{
                    'term' : trm,
                    'days' : dys,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                
                success: function(response) {
                    if(response.status){
                        document.getElementById("newTermForm").reset();
                        
                        var dropdown = $('#paymentTerm');
                        dropdown.empty();
                        dropdown.append(`<option value="" selected>Choose</option>`);
                        $.each(response, function(key, value) {
                            for(let i=0; i<value.length; i++){
                                if(value[i].name == trm){
                                    dropdown.append($('<option selected></option>').attr('text',value[i].days).text(value[i].name).val(value[i].id))
                                }else{
                                    dropdown.append($('<option></option>').attr('text',value[i].days).text(value[i].name).val(value[i].id))
                                }   
                            }
                        });

                        findDueDate();

                    }else{
                        alert("Something went wrong.!")
                    }
                },         
            });
        }
        else{
            alert('Invalid')
        }
    });

    function findDueDate(){
        var days = parseInt($('#paymentTerm').find(":selected").attr('text'))
        start_date =new Date($('#startDate').val())

        if (!isNaN(start_date.getTime())) {

            const endDate = new Date(start_date);
            endDate.setDate(endDate.getDate() + days);

            const isoString = endDate.toISOString(); 
            const day = isoString.slice(8, 10);
            const month = isoString.slice(5, 7);
            const year = isoString.slice(0, 4);

            const formattedDate = `${day}-${month}-${year}`;

            document.getElementById("endDate").value = formattedDate;
        } else {
                alert("Please enter a valid date.");
                $('#paymentTerm').val('')
        }
    }

    $('#paymentTerm').on('change', function () {
        findDueDate();
    });

    $('#startDate').on('change', function() {
        findDueDate();
    });

    function refreshTax(){
        var cmpState = $('#cmpstate').val();
        var plc = $('#placeOfSupply').val();
        if(cmpState == plc){
            $('.tax_ref').css('display','none');
            $('.tax_ref_gst').css('display','block');
            document.getElementById('taxamountCGST').style.display = 'flex';
            document.getElementById('taxamountSGST').style.display = 'flex';
            document.getElementById('taxamountIGST').style.display = 'none';
        }else{
            $('.tax_ref').css('display','none');
            $('.tax_ref_igst').css('display','block');
            document.getElementById('taxamountCGST').style.display = 'none';
            document.getElementById('taxamountSGST').style.display = 'none';
            document.getElementById('taxamountIGST').style.display = 'flex';
        }
    }

    function checkPriceList(){
      if($('#applyPriceList').prop('checked')){
        if($('#priceListIds').val() != ""){
            $('.price').css('display','none');
            $('.priceListPrice').css('display','block');
            $('#custPriceListName').css('display','inline-flex');
        }
        else{
            $('.priceListPrice').css('display','none');
            $('.price').css('display','block');
            $('#custPriceListName').css('display','none');
        }
      }else{
          $('.priceListPrice').css('display','none');
          $('.price').css('display','block');
          $('#custPriceListName').css('display','none');
      }
      calc();
    }

  function applyPriceList(){
    $('#applyPriceList').prop('checked') ? $('#applyPriceList').prop('checked', true) : $('#applyPriceList').prop('checked', true);
    $('#items-table-body tr').each(function () {
        var html = $(this).html();
        if (html != '') {
            var itemId = $(this).find('.item-display').attr('id');
            var itemName = $('#'+itemId).val();
            console.log(itemId,itemName);

            var plc = $('#placeOfSupply').val();
            var PLId = $('#priceListIds').val();

            if(PLId != ""){
                if(plc != ""){
                    $('#custPriceListAlert').hide();
                    $('#custPriceListName').text('Applied: '+$("#priceListIds option:selected").text())
                    var n = itemId.slice(4);
                    $.ajax({
                    url: "{% url 'getItemDetailsAjax' %}",
                    type : 'GET',
                    data:{
                        item : itemName,
                        listId : PLId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                    
                    success: function(response) {
                        if (response.status){
                            $('#'+itemId).val(itemName);
                            document.getElementById('itemId'+n).value = response.id;
                            document.getElementById('hsn'+n).value = response.hsn;
                            document.getElementById('qtyspan'+n).innerHTML = response.avl;
                            document.getElementById('avl'+n).innerHTML = response.avl;
                            document.getElementById('price'+n).value = response.sales_rate;
                            document.getElementById('priceListPrice'+n).value = response.PLPrice;
                            document.getElementById('taxGST'+n).value = response.gst;
                            document.getElementById('taxIGST'+n).value = response.igst;
                            refreshTax();
                            calc();
                        }
                    },
                    });
                }else{
                    alert('Select Place of Supply.!')
                }
            }else{
                // alert('Choose a Price List.!')
                $('#custPriceListAlert').text('Select a Price List..').show()
                $('#applyPriceList').prop('checked',false);
            }
        }
        checkPriceList();
    });
  }

  $(document).on('change','#priceListIds', function() {
      applyPriceList();
  });

  $(document).on('change','#applyPriceList', function() {
      checkPriceList();
      if($('#applyPriceList').prop('checked')){
          $('#priceListDropdown').css('display','block');
          $('#custPriceListName').text('Select Price List..').show();
      }else{
          $('#priceListIds').val('');
          $('#priceListDropdown').css('display','none');
          $('#custPriceListName').text('').hide();
      }
  });

  $(document).on('change','#recInvoiceNumber', function() {
        $('#invNoErr').text('');
        var inv_num = $(this).val();
        if(inv_num != ""){
            console.log(inv_num);
            $.ajax({
                type: "GET",
                url: "{% url 'checkRecurringInvoiceNumber' %}",
                data: {
                    RecInvNum : inv_num,
                },
                success: function (response) {
                    if (response.status){
                        $('#invNoErr').text('');
                    }else{
                        $('#invNoErr').text(response.message);
                    }
                }
            })
        }
    });

    $(document).on('change','#placeOfSupply',function()   {
        refreshTax();
        calc();
    });

    function filterFunction(id){
        var options = $('#'+ $("#"+id).next().attr('id')).children();
        var search_text = $("#"+id).val().toLowerCase();
        options.each(function(){
            if($(this).text().toLowerCase().includes(search_text)){
                $(this).show()
            }else{
                $(this).hide()
            }
        })
    }
    
    function getItemDetails(inpId, value){
      var itm = value;
      var exists = false;
      var plc = $('#placeOfSupply').val();
      var PLId = $('#priceListIds').val();

      $('#items-table-body tr').each(function () {
          var html = $(this).html();
          if (html != '') {
              var itemName = $(this).find('.item-display').val();
              console.log(itm,itemName);
              if(itemName == itm){
                  exists = true;
                  console.log('exists',exists);
              }
          }
      });
      console.log('status',exists);

      if(!exists){
          if(plc != ""){
              if($('#applyPriceList').prop('checked') && PLId ==""){
                  alert('Select a Price List from the dropdown..!')
              }else{
                  var n = inpId.slice(4);
                  $.ajax({
                      url: "{% url 'getItemDetailsAjax' %}",
                      type : 'GET',
                      data:{
                          item : value,
                          listId : PLId,
                          csrfmiddlewaretoken: '{{ csrf_token }}'
                          },
                      
                      success: function(response) {
                          if (response.status){
                              $('#'+inpId).val(value);
                              document.getElementById('itemId'+n).value = response.id;
                              document.getElementById('hsn'+n).value = response.hsn;
                              document.getElementById('qtyspan'+n).innerHTML = response.avl;
                              document.getElementById('avl'+n).innerHTML = response.avl;
                              document.getElementById('price'+n).value = response.sales_rate;
                              document.getElementById('priceListPrice'+n).value = response.PLPrice;
                              document.getElementById('taxGST'+n).value = response.gst;
                              document.getElementById('taxIGST'+n).value = response.igst;
                              refreshTax();
                              calc();
                          }
                      },
                  });
              }
              
          }else{
              alert('Select Place of Supply.!')
          }
      }else{
          alert('Item already exists in the RECURRING INVOICE, choose another or change quantity.!')
      }

    }

    function changeItemQty(id){
        id_val = id.slice(3)
        var qty = document.getElementById(id).value;
        var avl_val = document.getElementById(`avl${id_val}`).innerText;
    
        if( parseInt(qty) > parseInt(avl_val) ){
            alert("Quantity Greater than Available Quantity")
            document.getElementById(id).value = avl_val;
            calc()
        }else{
            document.getElementById(`qtyspan${id_val}`).textContent = parseInt(avl_val) - parseInt(qty);
        }
    }

    $(document).ready(function(){
        $('#items-table-body').on('keyup change', function () {
            refreshTax();
            calc();
        });
    });

    $(document).ready(function(){
        $(document).on("blur", ".disc", function(){
            if($(this).val() != ""){
            }else{
            $(this).val(0);
            calc();
            }
        }); 
    });

    // calculation---------------------------

    function calc() {
      $('#invoiceItemsTable tbody tr').each(function () {
        var html = $(this).html();
        if (html != '') {
          var qty = $(this).find('.qty').val();
          if($('#applyPriceList').prop('checked') && $('#priceListIds').val() != ""){
              var price = $(this).find('.priceListPrice').val();
          }else{
              var price = $(this).find('.price').val();
          }
          var dis = $(this).find('.disc').val();
          var bc = $("#placeOfSupply").val();
          var compstate = $("#cmpstate").val();

          if(bc==compstate){
              var tax = $(this).find('.tax_ref_gst').val();
          }
          else{
              var tax = $(this).find('.tax_ref_igst').val();
          }
          $(this).find('.total').val((parseFloat(qty) * parseFloat(price)) - parseFloat(dis));
          $(this).find('.itemTaxAmount').val(((qty * price)-dis) * (tax / 100));
          calc_total();
        }
      });
    }

    function calc_total() { 
      total = 0;
      $('.total').each(function () {
          total += parseFloat($(this).val());
      });
      taxamount = 0;
      $('.itemTaxAmount').each(function () {
          taxamount += parseFloat($(this).val());
      });
      $('#sub_total').val(total.toFixed(2));
      $('#tax_amount').val(taxamount.toFixed(2));
      var ship = parseFloat($("#ship").val());
      var adj_val = parseFloat($('#adj').val())
      var gtot = taxamount + total + ship + adj_val;

      $('#grandtotal').val(gtot.toFixed(2));
      
      var adv_val = parseFloat($('#advance').val())
      var bal = gtot - adv_val
      $('#balance').val(bal.toFixed(2));
      splitTax();
    }

    function splitTax(){
    var bc = $("#placeOfSupply").val();
    var compstate = $("#cmpstate").val();
    d=0
    if (bc == compstate  ) {
        var gst = taxamount/2
        $('#cgstAmount').val(parseFloat(gst.toFixed(2)));
        $('#sgstAmount').val(parseFloat(gst.toFixed(2)));
        $('#igstAmount').val(parseFloat(d.toFixed(2)));
    }else{
        $('#igstAmount').val(taxamount.toFixed(2));
        $('#cgstAmount').val(d.toFixed(2));
        $('#sgstAmount').val(d.toFixed(2));
    }   
  }

    $(document).ready(function(){
      $(document).on('keyup',"#ship",function(){
          var subtot = $('#sub_total').val();
          var tax = $('#tax_amount').val();
          var sh = $("#ship").val();
          var adj = $("#adj").val();
          $('#grandtotal').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(sh)+parseFloat(adj)).toFixed(2));
          $('#balance').val((parseFloat($("#grandtotal").val())-parseFloat($("#advance").val())).toFixed(2))
          
      });

      $(document).on("blur", "#ship", function(){
          if($(this).val() != ""){
          }else{
          $(this).val(0);
          calc_total();
          }
      }); 
    });

    $(document).ready(function(){
      $(document).on("keyup", "#adj", function(){
          var subtot = $('#sub_total').val();
          var tax = $('#tax_amount').val();
          var sh = $("#ship").val();
          var adj = $("#adj").val();
          $('#grandtotal').val((parseFloat(subtot)+parseFloat(tax)+parseFloat(sh)+parseFloat(adj)).toFixed(2));
          $('#balance').val((parseFloat($("#grandtotal").val())-parseFloat($("#advance").val())).toFixed(2))
      });

      $(document).on("blur", "#adj", function(){
          if($(this).val() != ""){
          }else{
          $(this).val(0);
          calc_total();
          }
      }); 
    });

    $(document).ready(function() {
      $("#advance").on('keyup change',function() {
          var tot_val = $('#grandtotal').val();
          var adv_val = $('#advance').val();
          if(adv_val !=""){
              if (parseFloat(tot_val) < parseFloat(adv_val)){
                  $('#advance').val(parseFloat(tot_val))
                  $('#balance').val(0);
                  alert("Advance Greater than Total Amount")
      
              }else{
                  var bal = parseFloat(tot_val) - parseFloat(adv_val)
                  $('#balance').val(bal.toFixed(2));
              }
          }else{
              $('#balance').val(parseFloat(tot_val));
          }
          
      })
    });

    // Tabel row add, clone, remove

    function refreshIndex(){
      var slNo = 1;
      var $rows = $("#items-table-body tr");

      for (var i = 0; i < $rows.length; i++) {
          $rows.eq(i).attr('id', 'tab_row'+slNo)
          $rows.eq(i).find('[id]').each(function() {
              var oldId = $(this).attr('id');
              var newId = oldId.replace(/\d+/, slNo);
              $(this).attr('id', newId );
          });

          $rows.eq(i).find('.nnum').text(slNo);
          slNo++;
      }
    }

    $(document).on('click','.remove_row',function(){
      var row_id = $(this).attr("id");
      $('#tab_row'+row_id+'').remove();
      refreshIndex();
      calc();
    });

    $(document).ready(function(){
      $('#add').click(function(){
        var roinc = $("#items-table-body tr").length;
        roinc++
        $('#items-table-body').append(
            `
            <tr id='tab_row${roinc}'>
              <td class="nnum  bg-black text-white" style="text-align: center;">${roinc}</td>
              <td>
                  <div class="d-flex">
                      <div class="w-100">
                          <div class="p-0 border-0 bg-none position-relative drop-box" style="display: block;">
                              <input required type="text" id="item${roinc}" value="" name="item_name[]" class="dropdown-toggle form-control text-white item-display" onkeyup="filterFunction($(this).attr('id'))"  data-bs-toggle="dropdown" aria-expanded="false" placeholder="Items.." autocomplete="off">
                              <ul class="dropdown-menu w-100 items-available position-absolute bg-black text-white" id="menu${roinc}"  style="overflow-y: auto; height: fit-content;max-height: 40vh; border: 1px solid gray;"> 
                                  {% for i in items %}
                                  <li class="dropdown-item items-options text-white" onclick="getItemDetails($(this).parent().prev().attr('id'),'{{i.item_name}}')">{{i.item_name}}</li>
                                  {% endfor %}
                              </ul>
                              
                          </div>
                      </div>
                      <a href="#">
                          <button type="button" class="btn btn-outline-warning ms-1" data-bs-target="#newItem" data-bs-toggle="modal">+</button>
                      </a>
                  </div>
              
              </td>
              <td>
                  <input type="hidden" name="item_id[]" id="itemId${roinc}">
                  <input type="text" name='hsn[]' id="hsn${roinc}" placeholder='HSN' class="form-control bg-black text-white HSNCODE" readonly />
              </td>
              <td >
                  <input type="number" name='qty[]' id="qty${roinc}"  class="form-control bg-black text-white qty mb-1" step=0 min=1 value=0 onchange="changeItemQty(this.id)" required/>
                  <input type="text" id="avl${roinc}" style="display: none;">
                  <div class="d-flex text-white" style="font-size: 0.7rem;"><span>Available Qty:</span><span id="qtyspan${roinc}" class=''></span></div>
              </td>
              <td>
                  <input type="number" name='price[]' id="price${roinc}" class="form-control bg-black text-white price" step="0.00" min="0" style="display: block;" value=0 readonly />
                  <input type="number" name='priceListPrice[]' id="priceListPrice${roinc}" class="form-control bg-black text-white priceListPrice" step="0.00" min="0" style="display: none;" value=0 readonly />
              </td>
              
              <td>
                  <select name='taxGST[]' id="taxGST${roinc}" class="form-control bg-black text-white tax_ref tax_ref_gst" style="display: block;" onchange="taxchange(this.id)">
                      <option selected disabled hidden>Select GST</option>
                      <option value=28 >28.0% GST</option>
                      <option value=18 >18.0% GST</option>
                      <option value=12 >12.0% GST</option>
                      <option value=5 >05.0% GST</option>
                      <option value=3 >03.0% GST</option>
                      <option value=0 >0.0% GST</option>
                  </select>
                  <select name='taxIGST[]' id="taxIGST${roinc}" class="form-control bg-black text-white tax_ref tax_ref_igst" style="display: none;" onchange="taxchange(this.id)">
                      <option selected disabled hidden >Select IGST</option>
                      <option value=28 >28.0% IGST</option>
                      <option value=18 >18.0% IGST</option>
                      <option value=12 >12.0% IGST</option>
                      <option value=5 >05.0% IGST</option>
                      <option value=3 >03.0% IGST</option>
                      <option value=0 >0.0% IGST</option>
                  </select>
                  <div class="mt-1" style=" text-align: center;color: red;" ><span id="invalidtax${roinc}" style="display: none;"> Invalid Tax %</span> </div>    
              </td>
              <td >
                  <input type="number" name='discount[]'  placeholder='Enter Discount' id="disc${roinc}" value=0 class="form-control bg-black text-white disc" step='any' min=0  />
              </td>

              <td><input type="number" name='total[]' id="total${roinc}" class="form-control bg-black text-white total" value=0 readonly /></td>
              <td style="display: none;"><input type="hidden" id="taxamount${roinc}" class="form-control itemTaxAmount" /></td>
              <td>
                <i class="fa fa-trash text-danger remove_row" style="cursor: pointer;" title="Remove Row" id="${roinc}"></i>
              </td>
          </tr>
            `);
            checkPriceList();
        });
    });
 
  
    function validateForm() {
        var cust = $('#customer').val();
        var length = $("#items-table-body tr").length;

        if(length < 1){
            alert('Add atleast 1 item..!')
            return false;
        }

        if(cust == 0){
            alert('Select customer..')
            return false;
        }

        if($('#applyPriceList').prop('checked') && $('#priceListIds').val() == ""){
            alert('Choose a Price List or continue with standard price.')
            return false;
        }
    }
</script>

{%endblock%}